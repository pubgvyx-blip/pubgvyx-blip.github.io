<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KRAKEN UC SHOP</title>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg: #090f1f;
      --bg-2: #101a37;
      --card: rgba(14, 23, 49, 0.85);
      --line: rgba(255,255,255,.1);
      --text: #eef2ff;
      --muted: #9db1df;
      --accent: #19d7ff;
      --brand: #7556ff;
      --success: #66ffa8;
      --danger: #ff5a8f;
      --warning: #ffd67e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Inter, Segoe UI, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 10% 20%, rgba(117,86,255,.30), transparent 35%),
        radial-gradient(circle at 90% 10%, rgba(25,215,255,.20), transparent 33%),
        linear-gradient(135deg, var(--bg), var(--bg-2));
      min-height: 100vh;
    }

    h1 {
      margin: 0;
      text-align: center;
      padding: 30px 15px 8px;
      text-transform: uppercase;
      letter-spacing: .04em;
      font-size: clamp(2rem, 3.2vw, 2.9rem);
      text-shadow: 0 0 18px rgba(117,86,255,.45);
    }

    .subtitle {
      margin: 0 auto 24px;
      max-width: 900px;
      text-align: center;
      color: var(--muted);
      padding: 0 15px;
    }

    .container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 0 16px 32px;
      display: grid;
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px;
      backdrop-filter: blur(9px);
    }

    .card h2 { margin: 0 0 12px; }

    .grid-2 {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    input, textarea {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #0f1938;
      color: var(--text);
      padding: 11px 12px;
    }

    textarea { min-height: 100px; resize: vertical; }

    .actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 14px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--brand), #5a38e5);
      transition: .2s ease;
    }

    button:hover { transform: translateY(-1px); }
    button.secondary { background: linear-gradient(135deg, #2e3b69, #1f2a4e); }

    .products {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .product {
      border: 1px solid rgba(117,86,255,.45);
      border-radius: 12px;
      padding: 14px;
      background: linear-gradient(155deg, #141f42, #101936);
    }

    .price { color: var(--accent); font-size: 1.2rem; font-weight: 700; margin: 6px 0 12px; }
    .hint { color: var(--muted); margin: 0 0 10px; }

    .status { min-height: 22px; margin-top: 8px; color: var(--muted); }
    .status.success { color: var(--success); }
    .status.error { color: var(--danger); }
    .status.warning { color: var(--warning); }

    #reviews > div,
    #ordersLocal > div {
      background: #121d3e;
      border-left: 4px solid var(--accent);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
    }

    .selected { color: var(--accent); font-weight: 700; }

    @media (max-width: 640px) {
      .card { padding: 14px; }
    }
  </style>
</head>
<body>
  <h1>KRAKEN UC SHOP</h1>
  <p class="subtitle">Код полностью обновлён: регистрация через Firebase Auth, заказ отправляется в Firestore `orders`, а при блокировке правил есть резерв в браузере и быстрый переход в Telegram.</p>

  <main class="container">
    <section class="card">
      <h2>Вход / Регистрация</h2>
      <div class="grid-2">
        <input type="email" id="email" placeholder="Email" autocomplete="email">
        <input type="password" id="password" placeholder="Пароль" autocomplete="current-password">
      </div>
      <div class="actions">
        <button type="button" id="loginBtn">Войти</button>
        <button type="button" id="registerBtn" class="secondary">Регистрация</button>
      </div>
      <div id="authStatus" class="status"></div>
    </section>

    <section class="card">
      <h2>Товары UC PUBG</h2>
      <p class="hint">Шаг 1: нажмите «Купить», затем заполните данные заказа ниже.</p>
      <div class="products">
        <article class="product">
          <h3>60 UC</h3>
          <p class="price">65 ₽</p>
          <button type="button" class="buyBtn" data-name="60 UC" data-price="65">Купить</button>
        </article>
        <article class="product">
          <h3>325 UC</h3>
          <p class="price">319 ₽</p>
          <button type="button" class="buyBtn" data-name="325 UC" data-price="319">Купить</button>
        </article>
        <article class="product">
          <h3>660 UC</h3>
          <p class="price">619 ₽</p>
          <button type="button" class="buyBtn" data-name="660 UC" data-price="619">Купить</button>
        </article>
      </div>
    </section>

    <section class="card" id="orderCard">
      <h2>Оформление заказа</h2>
      <p id="selectedProduct" class="selected">Шаг 2: выберите товар кнопкой «Купить».</p>
      <div class="grid-2">
        <input type="text" id="pubgId" placeholder="Ваш PUBG ID">
        <input type="text" id="contact" placeholder="Контакт: Telegram/WhatsApp">
      </div>
      <div class="actions">
        <button type="button" id="placeOrderBtn">Подтвердить заказ</button>
        <button type="button" id="telegramBtn" class="secondary">Написать в Telegram</button>
      </div>
      <p class="hint">Куда уходит заказ: в Firestore коллекцию <b>orders</b>. Если доступ запрещён, сохраняем локально и показываем менеджеру через Telegram.</p>
      <div id="orderStatus" class="status"></div>
    </section>

    <section class="card">
      <h2>Локальные заказы (резерв)</h2>
      <div id="ordersLocal"></div>
    </section>

    <section class="card">
      <h2>Отзывы</h2>
      <textarea id="reviewText" placeholder="Ваш отзыв"></textarea>
      <div class="actions">
        <button type="button" id="reviewBtn">Отправить</button>
      </div>
      <div id="reviewStatus" class="status"></div>
      <div id="reviews" style="margin-top: 12px;"></div>
    </section>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAdE6pSRtNx9AlEFR2UrFO87_fpFXLg9C4",
      authDomain: "krakenuc-dc537.firebaseapp.com",
      projectId: "krakenuc-dc537",
      storageBucket: "krakenuc-dc537.firebasestorage.app",
      messagingSenderId: "814916661220",
      appId: "1:814916661220:web:1f4a7e050c390f9c27e1f1",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const $ = (id) => document.getElementById(id);
    const authStatus = $("authStatus");
    const orderStatus = $("orderStatus");
    const reviewStatus = $("reviewStatus");
    const selectedProductLabel = $("selectedProduct");
    const ordersLocal = $("ordersLocal");
    const reviews = $("reviews");

    let selectedProduct = null;

    function setStatus(node, text, type = "") {
      node.textContent = text;
      node.className = `status ${type}`.trim();
    }

    function creds() {
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) {
        setStatus(authStatus, "Введите email и пароль.", "error");
        return null;
      }
      return { email, password };
    }

    async function register() {
      const data = creds();
      if (!data) {
        return;
      }

      try {
        await auth.createUserWithEmailAndPassword(data.email, data.password);
        setStatus(authStatus, "Регистрация успешна. Вы авторизованы.", "success");
      } catch (error) {
        setStatus(authStatus, `Ошибка регистрации: ${error.message}`, "error");
      }
    }

    async function login() {
      const data = creds();
      if (!data) {
        return;
      }

      try {
        await auth.signInWithEmailAndPassword(data.email, data.password);
        setStatus(authStatus, "Вход выполнен.", "success");
      } catch (error) {
        setStatus(authStatus, `Ошибка входа: ${error.message}`, "error");
      }
    }

    function chooseProduct(name, price) {
      selectedProduct = { name, price: Number(price) };
      selectedProductLabel.textContent = `Шаг 2: выбран товар ${name} (${price} ₽).`;
      setStatus(orderStatus, "Заполните PUBG ID и контакт, затем подтвердите заказ.");
      $("orderCard").scrollIntoView({ behavior: "smooth", block: "center" });
    }

    function getLocalOrders() {
      return JSON.parse(localStorage.getItem("ordersFallback") || "[]");
    }

    function saveLocalOrder(order) {
      const list = getLocalOrders();
      list.unshift(order);
      localStorage.setItem("ordersFallback", JSON.stringify(list.slice(0, 8)));
    }

    function renderLocalOrders() {
      const list = getLocalOrders();
      ordersLocal.innerHTML = "";
      if (!list.length) {
        ordersLocal.innerHTML = "<div>Пока пусто.</div>";
        return;
      }

      list.forEach((item) => {
        const div = document.createElement("div");
        div.innerHTML = `<strong>${item.product}</strong> • ${item.price} ₽<br>PUBG ID: ${item.pubgId}<br>Контакт: ${item.contact}`;
        ordersLocal.appendChild(div);
      });
    }

    async function placeOrder() {
      if (!selectedProduct) {
        setStatus(orderStatus, "Сначала выберите товар кнопкой «Купить».", "error");
        return;
      }

      const pubgId = $("pubgId").value.trim();
      const contact = $("contact").value.trim();
      if (!pubgId || !contact) {
        setStatus(orderStatus, "Заполните PUBG ID и контакт.", "error");
        return;
      }

      const payload = {
        product: selectedProduct.name,
        price: selectedProduct.price,
        pubgId,
        contact,
        customerEmail: auth.currentUser?.email || "guest",
        customerUid: auth.currentUser?.uid || null,
        status: "new",
        createdAt: Date.now(),
      };

      try {
        await db.collection("orders").add(payload);
        setStatus(orderStatus, "Заказ отправлен в Firestore (orders).", "success");
      } catch (error) {
        saveLocalOrder(payload);
        renderLocalOrders();
        setStatus(orderStatus, `Firestore недоступен (${error.message}). Заказ сохранён локально.`, "warning");
      }
    }

    function openTelegram() {
      const productText = selectedProduct ? `${selectedProduct.name} ${selectedProduct.price}₽` : "товар не выбран";
      const pubgId = $("pubgId").value.trim() || "не указан";
      const contact = $("contact").value.trim() || "не указан";
      const text = encodeURIComponent(`Здравствуйте! Хочу заказать ${productText}. PUBG ID: ${pubgId}. Контакт: ${contact}`);
      window.open(`https://t.me/share/url?url=https://pubgvyx-blip.github.io&text=${text}`, "_blank");
    }

    async function addReview() {
      const text = $("reviewText").value.trim();
      if (!text) {
        setStatus(reviewStatus, "Введите текст отзыва.", "error");
        return;
      }

      try {
        await db.collection("reviews").add({
          text,
          user: auth.currentUser?.email || "Гость",
          date: Date.now(),
        });
        $("reviewText").value = "";
        setStatus(reviewStatus, "Отзыв отправлен.", "success");
      } catch (error) {
        setStatus(reviewStatus, `Ошибка отправки отзыва: ${error.message}`, "error");
      }
    }

    db.collection("reviews").orderBy("date", "desc").onSnapshot((snapshot) => {
      reviews.innerHTML = "";
      snapshot.forEach((doc) => {
        const data = doc.data();
        const div = document.createElement("div");
        div.innerHTML = `<strong>${data.user || "Гость"}</strong><br>${data.text || ""}`;
        reviews.appendChild(div);
      });
    }, (error) => {
      setStatus(reviewStatus, `Не удалось загрузить отзывы: ${error.message}`, "error");
    });

    $("registerBtn").addEventListener("click", register);
    $("loginBtn").addEventListener("click", login);
    $("placeOrderBtn").addEventListener("click", placeOrder);
    $("telegramBtn").addEventListener("click", openTelegram);
    $("reviewBtn").addEventListener("click", addReview);
    document.querySelectorAll(".buyBtn").forEach((btn) => {
      btn.addEventListener("click", () => chooseProduct(btn.dataset.name, btn.dataset.price));
    });

    renderLocalOrders();
  </script>
</body>
</html>
